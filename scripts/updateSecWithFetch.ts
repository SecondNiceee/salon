// scripts/updateSeoWithFetch.ts

// ‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π URL Payload CMS
const API_URL = "http://localhost:3000/api/products"; // ‚Üê –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/api/products

// –ü–æ–ª—É—á–∞–µ–º API-–∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
const API_KEY = process.env.PAYLOAD_API_KEY;

// ----- –°–ï–ú–ê–ù–¢–ò–ß–ï–°–ö–ê–Ø –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø –ò –®–ê–ë–õ–û–ù–´ -----

const serviceCategories = {
  course: [
    "–∫—É—Ä—Å", "–æ–±—É—á–µ–Ω–∏–µ", "–º–∞—Å—Ç–µ—Ä", "–±—Ä–æ–≤–∏—Å—Ç", "–¥–µ–ø–∏–ª—è—Ü", "–ø–∏–ª–∏–Ω–≥", "–º–µ–∑–æ—Ç–µ—Ä–∞–ø",
    "–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥", "—Å–µ—Å—Ç—Ä–∏–Ω—Å–∫–æ–µ", "—ç—Å—Ç–µ—Ç–∏—Å—Ç", "permanent", "—Ç–∞—Ç—É–∞–∂", "–º–∏–Ω–∏-—Ç–∞—Ç—É",
    "–≤–∞–∫—Å–∏–Ω–≥", "—à—É–≥–∞—Ä–∏–Ω–≥", "–º–∞—Å—Å–∞–∂–∏—Å—Ç–∞", "—Å–ø–∞-–º–∞—Å—Å–∞–∂–∏—Å—Ç–∞"
  ],
  spa: [
    "—Å–ø–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞", "vip —Å–ø–∞", "—Ä–µ–ª–∞–∫—Å", "–≤—Ç–æ—Ä–æ–µ –¥—ã—Ö–∞–Ω–∏–µ", "–º–µ–¥–∏—Ç–∞—Ü–∏—è", "energy",
    "—Ç–∞–π—Å–∫–∞—è —Å–∫–∞–∑–∫–∞", "—Ç—Ä–æ–ø–∏—á–µ—Å–∫–∞—è –Ω–æ—á—å", "–º–æ–Ω–∞—Ä—Ö", "–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π –≥–ª–∏–Ω—Ç–≤–µ–π–Ω",
    "–∂–∏–∑–Ω—å –≤ —à–æ–∫–æ–ª–∞–¥–µ", "—Ä–æ—Å–∫–æ—à—å –æ–∫–µ–∞–Ω–∞", "–∂–µ–º—á—É–∂–∏–Ω–∞ –º–æ—Ä—è", "—Å–µ–º—å —á—É–¥–µ—Å —Å–≤–µ—Ç–∞",
    "—Å–∏–±–∏—Ä—å", "–∞—Ç–ª–∞–Ω—Ç–∏–¥–∞", "–∫–æ—Å—Ç–∞-—Ä–∏–∫–∞", "–º–∞–ª—å–¥–∏–≤—ã", "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ", "—Ü–∏—Ç—Ä—É—Å–æ–≤—ã–π –≤–∑—Ä—ã–≤",
    "slimming day", "–≥–æ–∞", "–∫–æ–∫–æ—Å–æ–≤—ã–π —Ä–∞–π", "–ª–µ—Ç–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –≤ —Ç–∞–µ",
    "—Å–ª–∞–¥–∫–∞—è –ø–∞—Ä–æ—á–∫–∞", "—Ä–∞–π –Ω–∞ –¥–≤–æ–∏—Ö", "–ø–æ–¥ –ø–∞–ª—å–º–æ–π", "—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ", "rehabilitation",
    "–∏—Å–ø–∞–Ω—Å–∫–∞—è", "–∏–Ω–¥–∏–π—Å–∫–∞—è", "–∫—Ä–µ–æ–ª—å—Å–∫–∞—è", "–º–∞—Ä–æ–∫–∫–∞–Ω—Å–∫–∞—è", "—Ç–∏–±–µ—Ç—Å–∫–∞—è", "—è–ø–æ–Ω—Å–∫–∞—è",
    "—Å—á–∞—Å—Ç—å–µ –±—ã—Ç—å"
  ],
  tattoo: [
    "—Ç–∞—Ç—É", "–∑–∞–∫–∞–∑–∞—Ç—å —Ç–∞—Ç—É", "–∫–æ—Ä—Ä–µ–∫—Ü–∏—è", "–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ", "–Ω–∞ –≥—Ä—É–¥—å", "–Ω–∞ —Å–ø–∏–Ω–µ",
    "–Ω–∞ –Ω–æ–≥–µ", "—Ä—É–∫–∞–≤", "–Ω–∞ –ø–ª–µ—á–æ", "–Ω–∞ —Ä—É–∫–µ", "–Ω–∞ —à–µ–µ", "–Ω–∞ –∑–∞–ø—è—Å—Ç—å–µ", "–Ω–∞–¥–ø–∏—Å—å"
  ],
  massage: [
    "–º–∞—Å—Å–∞–∂", "—Å–ø–∞-–º–∞—Å—Å–∞–∂", "–ª–∏–º—Ñ–æ–¥—Ä–µ–Ω–∞–∂", "lpg", "–∞–Ω—Ç–∏—Ü–µ–ª–ª—é–ª–∏—Ç", "—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π",
    "—Ç–∞–π—Å–∫–∏–π", "—Ç–∏–±–µ—Ç—Å–∫–∏–π", "—Å—Ç–æ—É–Ω—Ç–µ—Ä–∞–ø–∏—è", "—à–∏–∞—Ü—É", "—è–ø–æ–Ω—Å–∫–∏–π –º–∞—Å—Å–∞–∂ –ª–∏—Ü–∞",
    "–±—É–∫–∫–∞–ª—å–Ω—ã–π", "–ø–ª–∞—Å—Ç–∏—á–µ—Å–∫–∏–π", "–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂ –ª–∏—Ü–∞", "–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π",
    "–¥–µ—Ç—Å–∫–∏–π", "–º–∞—Å—Å–∞–∂ –≤ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ —Ñ–∏–≥—É—Ä—ã", "–∫—Ä–µ–æ–ª—å—Å–∫–∏–π"
  ],
  certificate: [
    "—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç", "–ø–æ–¥–∞—Ä–æ—á–Ω—ã–π", "—ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ—á–Ω—ã–π", "—Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∫—É—Ä—å–µ—Ä–æ–º"
  ],
  other: [
    "–¥–µ–ø–∏–ª—è—Ü–∏—è", "–∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—è", "–∞–±–æ–Ω–µ–º–µ–Ω—Ç", "–∫–æ—Å–º–µ—Ç–∏–∫–∞-—ç—Å—Ç–µ—Ç–∏—Å—Ç"
  ]
};

function detectServiceType(title: string): keyof typeof serviceCategories {
  const lower = title.toLowerCase();
  for (const [type, keywords] of Object.entries(serviceCategories)) {
    if (keywords.some(kw => lower.includes(kw))) {
      return type as keyof typeof serviceCategories;
    }
  }
  return "other";
}

const seoTemplates = {
  course: [
    `–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã ¬´{{title}}¬ª –≤ /city ‚Äî –æ–±—É—á–µ–Ω–∏–µ —Å –Ω—É–ª—è –æ—Ç –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏—Ö –º–∞—Å—Ç–µ—Ä–æ–≤.`,
    `–û—Å–≤–æ–π—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é: –∫—É—Ä—Å—ã ¬´{{title}}¬ª –≤ /city/p —Å –≤—ã–¥–∞—á–µ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.`,
    `–õ—É—á—à–∏–µ –∫—É—Ä—Å—ã –ø–æ ¬´{{title}}¬ª –≤ /city ‚Äî –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è.`,
    `–°—Ç–∞–Ω—å—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º –≤ /city: –∫—É—Ä—Å—ã ¬´{{title}}¬ª –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö –∏ –æ–ø—ã—Ç–Ω—ã—Ö.`
  ],
  spa: [
    `–†–æ—Å–∫–æ—à–Ω–∞—è –°–ü–ê-–ø—Ä–æ–≥—Ä–∞–º–º–∞ ¬´{{title}}¬ª –≤ /city ‚Äî –ø–æ–≥—Ä—É–∑–∏—Ç–µ—Å—å –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —Ä–µ–ª–∞–∫—Å–∞ –∏ –≥–∞—Ä–º–æ–Ω–∏–∏.`,
    `–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –°–ü–ê-–ø—Ä–æ–≥—Ä–∞–º–º–∞ ¬´{{title}}¬ª –≤ /city/p ‚Äî –ø–æ–¥–∞—Ä–∏—Ç–µ —Å–µ–±–µ –º–æ–º–µ–Ω—Ç –±–ª–∞–∂–µ–Ω—Å—Ç–≤–∞.`,
    `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ ¬´{{title}}¬ª –≤ /city ‚Äî —ç–∫–∑–æ—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Ç—É–∞–ª—ã –∏ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —É—Ö–æ–¥ –∑–∞ —Ç–µ–ª–æ–º.`,
    `–°–ü–ê-–ø—Ä–æ–≥—Ä–∞–º–º–∞ ¬´{{title}}¬ª –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ /city ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–Ω—è—Ç—å —Å—Ç—Ä–µ—Å—Å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.`
  ],
  tattoo: [
    `–ó–∞–∫–∞–∂–∏—Ç–µ —Ç–∞—Ç—É ¬´{{title}}¬ª –≤ /city ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ.`,
    `–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–Ω–µ—Å–µ–Ω–∏–µ —Ç–∞—Ç—É ¬´{{title}}¬ª –≤ /city/p –æ—Ç –ø—Ä–∏–∑–Ω–∞–Ω–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤.`,
    `–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∞ ¬´{{title}}¬ª –≤ /city ‚Äî –≤–∞—à —Å—Ç–∏–ª—å, –≤–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è.`,
    `–°–æ–∑–¥–∞–π—Ç–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —ç—Å–∫–∏–∑ —Ç–∞—Ç—É ¬´{{title}}¬ª –≤ /city ‚Äî –∑–∞–ø–∏—Å—å –æ–Ω–ª–∞–π–Ω.`
  ],
  massage: [
    `–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π {{title}} –≤ /city ‚Äî —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ, –∑–¥–æ—Ä–æ–≤—å–µ –∏ –∫—Ä–∞—Å–æ—Ç–∞ –≤ –æ–¥–Ω–æ–º —Å–µ–∞–Ω—Å–µ.`,
    `–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ {{title}} –≤ /city/p ‚Äî –æ–ø—ã—Ç–Ω—ã–µ –º–∞—Å—Å–∞–∂–∏—Å—Ç—ã –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞.`,
    `–õ–µ—á–µ–±–Ω—ã–π –∏ —Ä–µ–ª–∞–∫—Å–∏—Ä—É—é—â–∏–π {{title}} –≤ /city ‚Äî –ø–æ—á—É–≤—Å—Ç–≤—É–π—Ç–µ —Ä–∞–∑–Ω–∏—Ü—É —Å –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞.`,
    `–ü–æ–ø—É–ª—è—Ä–Ω—ã–π {{title}} –¥–æ—Å—Ç—É–ø–µ–Ω –≤ /city ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ—Å–ª–µ —Ç—è–∂—ë–ª–æ–≥–æ –¥–Ω—è.`
  ],
  certificate: [
    `–ü–æ–¥–∞—Ä–∏—Ç–µ —ç–º–æ—Ü–∏–∏! {{title}} ‚Äî –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞ –≤ /city —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∏–ª–∏ –æ–Ω–ª–∞–π–Ω-–æ—Ç–ø—Ä–∞–≤–∫–æ–π.`,
    `–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∏–ª–∏ –±—É–º–∞–∂–Ω—ã–π {{title}} –≤ /city/p ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è –±–ª–∏–∑–∫–∏—Ö.`,
    `–ó–∞–∫–∞–∂–∏—Ç–µ {{title}} –≤ /city ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–ª–∏ –∫—É—Ä—å–µ—Ä—Å–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞.`,
    `–ü–æ–¥–∞—Ä–æ—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç ¬´{{title}}¬ª ‚Äî –ø–æ—Ä–∞–¥—É–π—Ç–µ –±–ª–∏–∑–∫–∏—Ö —É—Å–ª—É–≥–∞–º–∏ –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞ –≤ /city.`
  ],
  other: [
    `–õ—É—á—à–∞—è —É—Å–ª—É–≥–∞ ¬´{{title}}¬ª –≤ /city ‚Äî –∫–∞—á–µ—Å—Ç–≤–æ, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ –≤—Ä–µ–º–µ–Ω–µ–º.`,
    `–ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ ¬´{{title}}¬ª –≤ /city/p ‚Äî –≤–∞—à –∫–æ–º—Ñ–æ—Ä—Ç –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ.`,
    `–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π ¬´{{title}}¬ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤ /city ‚Äî –¥–æ–≤–µ—Ä—å—Ç–µ—Å—å —ç–∫—Å–ø–µ—Ä—Ç–∞–º.`,
    `–ü—Ä–µ–º–∏—É–º-—É—Å–ª—É–≥–∞ ¬´{{title}}¬ª –≤ /city ‚Äî –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ü–µ–Ω–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.`
  ]
};

function generateSmartSeoDescription(title: string): string {
  const type = detectServiceType(title);
  const templates = seoTemplates[type];
  const index = Math.abs(
    title.split("").reduce((a, b) => (a << 5) - a + b.charCodeAt(0), 0)
  ) % templates.length;
  let template = templates[index];

  // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
  template = template.replace(/\{\{title\}\}/g, title.trim());

  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–ª–∏–Ω–µ (SEO best practice: 150‚Äì160 —Å–∏–º–≤–æ–ª–æ–≤)
  if (template.length > 160) {
    template = template.substring(0, 157) + "...";
  }

  return template;
}

// ----- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê -----

async function fetchAndUpdateProducts() {
  if (!API_KEY) {
    console.warn("‚ö†Ô∏è PAYLOAD_API_KEY –Ω–µ –∑–∞–¥–∞–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç.");
  }

  console.log("üì° –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ API...");

  const readResponse = await fetch(`${API_URL}?limit=1000&depth=0`, {
    headers: API_KEY ? { Authorization: `users ${API_KEY}` } : {},
  });

  if (!readResponse.ok) {
    throw new Error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤: ${readResponse.status} ${readResponse.statusText}`);
  }

  const { docs: products } = await readResponse.json();
  console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${products.length}`);

  for (const product of products) {
    const currentSeo = product.seoDescription || "";
    if (currentSeo.includes("/city")) {
      console.log(`‚è≠Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º ID=${product.id} ‚Äî —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç /city`);
      continue;
    }

    const newSeo = generateSmartSeoDescription(product.title);
    console.log(`‚úçÔ∏è  –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID=${product.id}: ${newSeo}`);

    const updateResponse = await fetch(`${API_URL}/${product.id}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        ...(API_KEY ? { Authorization: `users ${API_KEY}` } : {}),
      },
      body: JSON.stringify({ seoDescription: newSeo }),
    });

    if (!updateResponse.ok) {
      const errorText = await updateResponse.text();
      console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ID=${product.id}:`, errorText);
    }
  }

  console.log("\nüéâ –í—Å–µ —Ç–æ–≤–∞—Ä—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!");
  process.exit(0);
}

// –ó–∞–ø—É—Å–∫
fetchAndUpdateProducts().catch((err) => {
  console.error("üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", err);
  process.exit(1);
});